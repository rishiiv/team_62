WITH daily_sales AS ( SELECT DATE_TRUNC('week', so.order_datetime) AS week_start, DATE(so.order_datetime) AS day, SUM(so.total_amount) AS day_sales FROM sales_orders so GROUP BY 1, 2 ), worst_day AS ( SELECT DISTINCT ON (week_start) week_start, day, day_sales FROM daily_sales ORDER BY week_start, day_sales ASC ), item_counts_on_worst_day AS ( SELECT DATE_TRUNC('week', so.order_datetime) AS week_start, DATE(so.order_datetime) AS day, soi.menu_item_id, SUM(soi.quantity) AS qty_sold FROM sales_orders so JOIN sales_order_items soi ON soi.order_id = so.order_id JOIN worst_day wd ON wd.week_start = DATE_TRUNC('week', so.order_datetime) AND wd.day = DATE(so.order_datetime) GROUP BY 1, 2, 3 ), top_item AS ( SELECT week_start, day, menu_item_id, qty_sold, ROW_NUMBER() OVER (PARTITION BY week_start ORDER BY qty_sold DESC) AS rn FROM item_counts_on_worst_day ) SELECT wd.week_start, wd.day AS lowest_sales_day, wd.day_sales AS lowest_day_sales, m.name AS top_seller_menu_item, t.qty_sold AS top_seller_qty FROM worst_day wd JOIN top_item t ON t.week_start = wd.week_start AND t.rn = 1 JOIN menu_items m ON m.menu_item_id = t.menu_item_id ORDER BY wd.week_start;